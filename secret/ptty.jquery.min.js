/**
 * @file   : ptty.jquery.min.js
 * @ver    : 0.0.5 (beta)
 * @author : Pachanka <social@pachanka.org>
 * @url    : http://goto.pachanka.org/ptty/docs
 * @desc   : Ptty (Pseudo teletype). A terminal emulator plugin for jQuery. 
 * @license: WTFPL Version 2. (http://www.wtfpl.net/)
 **/
!function(e){e.fn.Ptty=function(t){var n={};return this.each(function(){var o=e(this),i={},a={},r={},l={},s=[],d={ps:null,in:null,out:null,last:null,next:null,data:null},p=e.extend(!0,{ajax_options:{url:window.location.pathname,type:"POST"},param:"cmd",ps:"$",caret:"▮",caret_blink:800,native_css:!0,theme:"boring",native_cmds:!0,autocomplete:!0,history_max:800,autofocus:!0,before_cmd:!1,after_cmd:!1,i18n:{welcome:"Ptty (0.0.5 beta).<br> Type <b>help</b> to list the available commands.",error_not_found:"Command not found.",error_bad_method:"Invalid command method.",error_ajax:"Server error."}},t);n.get_terminal=function(e){return e?o.find(e):o},n.native_style=function(t,n){var o=t.attr("id");if(o=o?"#"+o:"."+t.attr("class").split(" ")[1],"boring"===n){var i=['.boring, .boring .prompt, .boring .content{ font-family: "Courier New", Courier, monospace; background-color: #111; color: #ddd; }',".boring .content{ padding: 15px 15px 0 15px; }",".boring .prompt{ padding: 0 15px 15px 15px; }",'.boring .loading span::after{content: "⚙"; color: #ddd; font-size: 10em; border-radius: 10em; opacity: 0.4;}',".boring .content ul{ margin: 0; }",".boring .prompt .input.show-caret{ color: #ddd; opacity: .85; }",".boring .prompt .input, .boring .prompt .input::before, .boring .prompt .input::after{ color: transparent; text-shadow:0 0 0 #ddd; }",".boring .content div .cmd_in .cmd_ps, .boring .prompt .input::before{ padding-right: 10px; }",".boring .content ul li{ list-style-type: none; }",".boring div.prompt div.input::after{ font-size: 2em; }",".boring div.prompt div.input, .boring div.content div div.cmd_in, .boring div.prompt div.input::before{ line-height: 2em; }"].join("\n");e('<style id="ptty-boring-theme">'+i+"</style>").appendTo("head")}var a=[o+"{ position: relative; display: block; overflow-X: hidden; height: 100%; }","div.content div p{ margin: 0; }","div.content div{ clear: both; white-space:pre-wrap; word-wrap:break-word; }","div.content div ul{ padding: 0; white-space: normal }","div.content div ul li{ list-style: none; }","div.content div ul.sq-li li{ display: inline-block; text-align: center; padding: 10px; min-width: 5%; }","div.prompt div.input{ width: 100%; white-space:pre-wrap; word-wrap:break-word; cursor: default; outline: none;}","div.prompt div.input::before{ vertical-align: middle; content: attr(data-ps); }","div.prompt div.input::after{ visibility : visible; vertical-align: middle; content: attr(data-caret); margin-left:-0.15em;}","div.prompt div.input.blink::after{ visibility : hidden; }","div.prompt .hide{ position:absolute; top: -9999em; }","div.loading{ display: none; }","div.loading.working{ display: block; display:flex; justify-content: center; align-items: center;position: fixed;  width: inherit; height: inherit; }","div.loading span{ -webkit-animation: spin 4s linear infinite; -moz-animation: spin 4s linear infinite; -ms-animation: spin 4s linear infinite; -o-animation: spin 4s linear infinite; animation: spin 4s linear infinite; }"].join("\n "+o+" ");e('<style id="ptty-styles">'+(a+="@-moz-keyframes spin { 100% { -moz-transform: rotate(360deg); } }@-webkit-keyframes spin { 100% { -webkit-transform: rotate(360deg); } }@-ms-keyframes spin { 100% { -ms-transform: rotate(360deg); } }@-o-keyframes spin { 100% { -o-transform: rotate(360deg); } }@keyframes spin { 100% { transform: rotate(360deg); } }")+"</style>").appendTo("head")},n.native_commands=function(){n.register("command",{name:"clear",method:function(e){return e.last="",e.out="",e},options:[],help:"Cleans the screen leaving a new command prompt ready."}),n.register("callback",{name:"clear",method:function(e){return o.find(".content").html(""),e}}),n.register("command",{name:"history",method:function(e){if(e.hasOwnProperty("clear"))s=[],e.out="History cleared.";else if(s.length>0){var t;e.out="<ul>";for(t in s)e.out+="<li>"+s[t]+"</li>";e.out+="</ul>"}return e},options:["clear"],help:"Shows list of typed in commands. Type <i>history clear</i> to clear your history."}),n.register("command",{name:"help",method:function(e){if("string"==typeof e[1]&&e[1].length>0)if(e.hasOwnProperty("-a")||e.hasOwnProperty("--all")){e.out="<b>Available commands:</b></br></br><ul>";for(var t=0;t<i.length;t++)e.out+="<li><p><b>"+t+"</b> - ",e.out+=i[t].help+"</p></br></li>";e.out+="</ul>\n"}else void 0!==i[e[1]]?(e.out="<b>"+e[1]+"</b> - ",""!==i[e[1]].help?e.out+=i[e[1]].help+"\n":e.out+="No help entry available.\n"):e.out='help: The "'+e[1]+'" option does not exist.\n';else{e.out='Use "help [comand name]" to display specific info about a command.</br>\n',e.out+='Available commands are:</br><ul class="sq-li">';for(var n=0;n<i.length;n++)e.out+="<li>"+n+"</li>";e.out+="</ul>\n"}return e},options:[1,"-a","--all"],help:"Displays a list of useful information. Usage: <i>help command-name</i> to show <i>command-name</i>'s help.<i>help -a</i> or <i>help --all</i> to display all help."})},n.native_responses=function(e){for(var t in e)e.hasOwnProperty(t)&&n.register("response",{name:t,method:function(n){return e[t]=n[t],n}})},n.run_command=function(e,t){quiet=t,y(e)},n.echo=function(e,t){e&&o.find(".content").append('<div><div class="cmd_out">'+e+"</div></div>"),t||P()},n.change_settings=function(t){e.extend(!0,p,t)},n.unregister=function(e,t){var n=!1;return"object"==typeof t&&t.hasOwnProperty("name")&&(t=t.name),"callbefore"==e&&l.hasOwnProperty(t)?(n=!0,delete l[t]):"command"==e&&i.hasOwnProperty(t)?(n=!0,delete i[t]):"response"==e&&a.hasOwnProperty(t)?(n=!0,delete a[t]):"callback"==e&&r.hasOwnProperty(t)&&(n=!0,delete r[t]),n},n.register=function(e,t){var n=!1;return t&&(method_name=!!t.hasOwnProperty("name")&&t.name,method_exe=!!t.hasOwnProperty("method")&&t.method,method_options=t.hasOwnProperty("options")?t.options:[],method_help=t.hasOwnProperty("help")?t.help:"","callbefore"==e&&"function"==typeof method_exe?(l[method_name]=method_exe,n=!0):"command"!=e||"string"!=typeof method_exe&&"function"!=typeof method_exe?"response"==e&&"function"==typeof method_exe?(a[method_name]=method_exe,n=!0):"callback"==e&&"function"==typeof method_exe&&(r[method_name]=method_exe,n=!0):(i[method_name]={help:method_help,options:method_options,exe:method_exe},n=!0)),n},n.set_command_option=function(t){return e.extend(!0,d,t)},n.get_command_option=function(e){var t;if("string"==typeof e)t=!!d.hasOwnProperty(e)&&d[e];else if("object"==typeof e){t={};for(var n=e.length-1;n>=0;n--)void 0!==d[e[n]]&&(t[e[n]]=d[e[n]])}else t=d;return t},n.tokenize=function(t,n){var o={},i=e.trim(t).split(/\s+/);if(void 0===i[0]||""===i[0])o=!1;else if(void 0!==n){var a=value=quote_type=quote_open=!1,r=last_char=before_last=!1,l=n.filter(function(e){if("number"==typeof e&&e>0&&void 0!==i[e])return o[e]=i[e],e});n=e(n).not(l).get();for(var s=0;s<i.length;s++)r=i[s].charAt(0),last_char=i[s].slice(-1),before_last=i[s].charAt(i[s].length-2),e.inArray(i[s],n)>=0?(a=i[s],value=!1):'"'==r&&!1===quote_open&&'"'!==last_char?(quote_type='"',quote_open=!0,value=i[s]):"'"==r&&!1===quote_open&&"'"!==last_char?(quote_type="'",quote_open=!0,value=i[s]):last_char==quote_type&&!0===quote_open&&before_last+last_char!=="\\"+quote_type?(quote_open=!1,value+=" "+i[s],value=e.trim(value.substring(1).slice(0,-1).replace(/\\(.)/gm,"$1"))):!0===quote_open?value+=" "+i[s]:"'"==r&&"'"==last_char||'"'==r&&'"'==last_char?value=e.trim(i[s].substring(1).slice(0,-1)):value=i[s],a&&!1===quote_open&&(o[a]=value)}else o[i[0]]=i;return o},o.html("");var c=null,u=null,m={};o.append('<div class="loading"><span></span></div><div class="content"><div>'+p.i18n.welcome+'</div></div><div class="prompt"><div class="input" contenteditable spellcheck="false" data-caret="'+p.caret+'" data-ps="'+p.ps+'"></div></div>');var f=o.find(".prompt .input"),h=o.find(".content"),v=o.find(".loading");o.attr("data-theme",p.theme).addClass(p.theme),p.native_css&&n.native_style(o,p.theme);var g=p.autofocus,b=p.autocomplete,_=p.history_max;p.autofocus&&f.focus(),o.bind("focus click",function(){var e="";void 0!==window.getSelection?e=window.getSelection().toString():void 0!==document.selection&&"Text"==document.selection.type&&(e=document.selection.createRange().text),""==e&&C()}),f.click(function(){C()}),f.bind("blur",function(){g=!1}),p.caret_blink>0&&setInterval(function(){p.caret_blink>0&&!0===g&&f.toggleClass("blink")},p.caret_blink),p.native_cmds&&n.native_commands(),n.native_responses(d),quiet=null;var y=function(t){var o;if(v.addClass("working"),o=void 0!==t?t:f.text(),b=p.autocomplete,_=p.history_max,d.last=o,"string"==typeof d.next&&(o=d.next.replace(/%cmd%/i,o),d.next=null,_=0),!o||""==o)return w();if(u=o.split(/\s+/)[0],void 0===i[u])return quiet||(d.out=u+" : "+p.i18n.error_not_found),w();if(m=n.tokenize(o,i[u].options),"function"==typeof p.before_cmd&&!(m=x(p.before_cmd(m))))return w();if("function"==typeof l[u]&&!(m=x(l[u](m))))return w();if(quiet||q(d.last),"function"==typeof i[u].exe)return x(i[u].exe(m)),w();if("string"!=typeof i[u].exe)return d.out=p.i18n.error_bad_method,w();var a={};if(!p.ajax_options.data){var r={};r[p.param]=null!==d.in?d.in:u,r[p.param+"_data"]=null!==d.data?d.data:m,a.data=r}var s=e.extend(!0,a,p.ajax_options);i[u].exe&&(s.url=i[u].exe);var c=e.ajax(s);c.done(function(e){m=x(e)}),c.fail(function(e,t,n){d.out=p.i18n.error_ajax}),c.always(function(e,t,n){return w()})},x=function(t){if("object"==typeof t)for(var n in t)a.hasOwnProperty(n)&&e.extend(!0,d,a[n](t));return t},w=function(){b=p.autocomplete,_=p.history_max;var e=d.ps?d.ps:p.ps,t=d.out?d.out:"",n=d.in?d.in:"",i=d.last?d.last:"",a=d.next?d.next:null;quiet?h.append('<div><div class="cmd_out">'+t+"</div></div>"):h.append('<div><div class="cmd_in"><span class="cmd_ps">'+f.attr("data-ps")+"</span>"+i+'</div><div class="cmd_out">'+t+"</div></div>"),m&&(r.hasOwnProperty(u)&&x(r[u](m)),"function"==typeof p.after_cmd&&x(p.after_cmd(m))),f.attr("data-caret",p.caret).attr("data-ps",e).text(n),0===p.caret_blink&&f.removeClass("blink"),f.hasClass("show-caret")&&f.removeClass("show-caret"),o.hasClass(p.theme)||o.removeClass(o.attr("data-theme")).addClass(p.theme).attr("data-theme",p.theme),a&&(b=!1,_=0),quiet=null,m=d={ps:null,in:null,out:null,last:null,next:a,data:null},k()},k=function(){P(),C(),v.removeClass("working")},q=function(t){void 0!==i[u]&&""!==t&&_>0&&(s.length>p.history_entries&&s.shift(),s.push(e.trim(t))),c=0},P=function(){o.scrollTop(o.height()+1e17)},C=function(){if(f.focus(),g=!0,void 0!==window.getSelection&&void 0!==document.createRange){var e=document.createRange();e.selectNodeContents(f.get(0)),e.collapse(!1);var t=window.getSelection();t.removeAllRanges(),t.addRange(e)}else if(void 0!==document.body.createTextRange){var n=document.body.createTextRange();n.moveToElementText(f.get(0)),n.collapse(!1),n.select()}};f.keydown(function(t){switch(t.keyCode){case 9:t.preventDefault(),b&&(!function(e){var t=[];if(e.match(/^[^\s]{0,}$/)){for(var n in i)""==e?t.push(n):0==n.indexOf(e)&&t.push(n);t.length>1?(d.out="<ul><li>"+t.join("</li><li>")+"</li></ul>",d.in=e,w()):1==t.length&&f.text(t.pop()+" ")}}(e.trim(f.text())),k());break;case 37:case 39:p.caret_blink>0&&(g=!1,f.addClass("blink show-caret"));break;case 38:t.preventDefault(),_>0&&(c=null===c||0==c?s.length-1:c-1,f.text(s[c]),k());break;case 40:if(t.preventDefault(),_>0){if(null===c||c==s.length-1){f.html("");break}c++,f.text(s[c]),k()}break;case 46:case 8:1!==f.text().length&&window.getSelection().toString()!=f.text()||f.html("");break;case 13:t.preventDefault(),document.execCommand("insertHTML",!1,""),y();break;case 27:d={ps:null,in:null,out:null,last:null,next:null,data:null},f.text(""),y()}})}),n}}(jQuery);